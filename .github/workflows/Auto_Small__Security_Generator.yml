name: Auto Small Security Generator

on:
  workflow_dispatch:
    inputs:
      account:
        description: 'Number of Accounts to generate (default=0)'
        required: false
        default: '0'
        type: string
      key:
        description: 'Number of Keys to generate (default=1)'
        required: false
        default: '1'
        type: string
      mail:
        description: 'Choose mail provider for license'
        required: true
        type: choice
        options:
          - 1secmail
          - guerrillamail
          - developermail
          - mailticking
          - fakemail
          - inboxes
          - incognitomail
          - emailfake
        default: emailfake
      key_type:
        description: 'Modes of operation'
        required: true
        type: choice
        options:
          - --key
          - --small-business-key
        default: --key
      os:
        description: 'Runner OS'
        required: true
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        default: windows-latest
      branch:
        description: 'Repository branch'
        required: false
        type: choice
        options:
          - main
          - test
        default: main

jobs:
  generate-account-and-key:
    runs-on: ${{ github.event.inputs.os || 'ubuntu-latest' }}
    steps:
      - name: Set Variables
        id: vars
        shell: bash
        run: |
          account="${{ github.event.inputs.account || '0' }}"
          key="${{ github.event.inputs.key || '1' }}"
          mail="${{ github.event.inputs.mail || 'emailfake' }}"
          key_type="${{ github.event.inputs.key_type || '--key' }}"
          branch="${{ github.event.inputs.branch || 'main' }}"
          echo "account=$account" >> $GITHUB_OUTPUT
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "mail=$mail" >> $GITHUB_OUTPUT
          echo "key_type=$key_type" >> $GITHUB_OUTPUT
          echo "branch=$branch" >> $GITHUB_OUTPUT

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clone Generator Repo
        run: git clone -b "${{ steps.vars.outputs.branch }}" https://github.com/Shariful797/E-S-ET-K-Gen.git

      - name: Setup Python (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd E-S-ET-K-Gen
          sudo apt update || true
          sudo apt install -y python3-pip python3-venv || true
          python3 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt requests pyTelegramBotAPI

      - name: Run Generator (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd E-S-ET-K-Gen
          source venv/bin/activate
          ACCOUNT="${{ steps.vars.outputs.account }}"
          KEY="${{ steps.vars.outputs.key }}"
          MAIL="${{ steps.vars.outputs.mail }}"
          KEY_TYPE="${{ steps.vars.outputs.key_type }}"

          if [[ "$ACCOUNT" != "0" ]]; then
            python3 main.py --auto-detect-browser --account --email-api "$MAIL" --token "${{ secrets.TOKEN }}" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat "$ACCOUNT"
          fi
          if [[ "$KEY" != "0" ]]; then
            python3 main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" --token "${{ secrets.TOKEN }}" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat "$KEY"
          fi

      - name: Setup Python (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd E-S-ET-K-Gen
          python -m venv venv
          .\venv\Scripts\python -m pip install --upgrade pip
          .\venv\Scripts\pip install -r requirements.txt requests pyTelegramBotAPI
          .\venv\Scripts\Activate.ps1

      - name: Run Generator (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd E-S-ET-K-Gen
          .\venv\Scripts\Activate.ps1
          $ACCOUNT = "${{ steps.vars.outputs.account }}"
          $KEY = "${{ steps.vars.outputs.key }}"
          $MAIL = "${{ steps.vars.outputs.mail }}"
          $KEY_TYPE = "${{ steps.vars.outputs.key_type }}"

          if ($ACCOUNT -ne 0) {
            python main.py --auto-detect-browser --account --email-api "$MAIL" --token "${{ secrets.TOKEN }}" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat $ACCOUNT
          }
          if ($KEY -ne 0) {
            python main.py --auto-detect-browser "$KEY_TYPE" --email-api "$MAIL" --token "${{ secrets.TOKEN }}" --skip-update-check --no-logo --disable-progress-bar --disable-logging --repeat $KEY
          }

      - name: Send Telegram Message (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        env:
          TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          cd E-S-ET-K-Gen
          source venv/bin/activate
          python3 - <<EOF
          import os
          import glob
          import requests
          
          token = os.environ.get("TOKEN")
          chat_id = os.environ.get("CHAT_ID")
          message = "ESET Generator Results\n\n"
          
          for f in glob.glob("*ACCOUNTS.txt"):
              with open(f) as file:
                  message += "Accounts:\n" + file.read() + "\n\n"
          
          for f in glob.glob("*KEYS.txt"):
              with open(f) as file:
                  message += "Keys:\n" + file.read() + "\n"
          
          url = f"https://api.telegram.org/bot{token}/sendMessage"
          requests.get(url, params={"chat_id": chat_id, "text": message})
          EOF

      - name: Send Telegram Message (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          cd E-S-ET-K-Gen
          .\venv\Scripts\Activate.ps1
          python - <<EOF
          import os
          import glob
          import requests
          
          token = os.environ.get("TOKEN")
          chat_id = os.environ.get("CHAT_ID")
          message = "ESET Generator Results\n\n"
          
          for f in glob.glob("*ACCOUNTS.txt"):
              with open(f) as file:
                  message += "Accounts:\n" + file.read() + "\n\n"
          
          for f in glob.glob("*KEYS.txt"):
              with open(f) as file:
                  message += "Keys:\n" + file.read() + "\n"
          
          url = f"https://api.telegram.org/bot{token}/sendMessage"
          requests.get(url, params={"chat_id": chat_id, "text": message})
          EOF
